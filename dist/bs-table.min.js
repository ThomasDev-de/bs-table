(function($){"use strict";$.bsTable={globalEventsBound:false,defaults:{classes:"table",toolbar:null,pagination:true,sidePagination:"client",paginationVAlign:"bottom",paginationHAlign:"end",pageNumber:1,pageSize:10,pageList:[5,10,25,50,100,200,"All"],search:true,sortName:null,sortOrder:"asc",showRefresh:true,showHeader:true,showFooter:false,url:null,data:null,columns:[],idField:null,icons:{sortAsc:"bi bi-caret-down-fill text-primary",sortDesc:"bi bi-caret-up-fill text-primary",sortNone:"bi bi-caret-down",refresh:"bi bi-arrow-clockwise",search:"bi bi-search",paginationNext:"bi bi-chevron-right",paginationprev:"bi bi-chevron-left"},rowStyle(row,index,$tr){},queryParams(params){return params},responseHandler(res){return res},caption:null,onAll(eventName,...args){},onLoadSuccess(){},onLoadError(){},onPreBody(rows,$table){},onPostBody(rows,$table){},onPostFooter($tfoot,$table){},onRefresh(params){},onSort(name,order){},onClickCell(field,value,row,$td){},onClickRow(row,$tr,field){},onCheck(row,$input){},onCheckAll(){},onUncheck(row,$input){},onUncheckAll(){},formatNoMatches(){return`<i class="bi bi-x-lg fs-3"></i>`},debug:false}};const wrapperClass="bs-table-wrapper";const wrapperTableClass="bs-table-inner-wrapper";const wrapperOverlayClass="bs-table-wrapper-overlay";const wrapperSearchClass="bs-table-wrapper-search";const wrapperPaginationClass="bs-table-pagination-container";const wrapperPaginationDetailsClass="bs-table-pagination-details";const inputSearchClass="bs-table-search-input";const namespace=".bs.table";$.fn.bsTable=function(optionsOrMethod,...args){if($(this).length===0){return}if($(this).length>1){return $(this).each(function(){return $(this).bsTable(optionsOrMethod,...args)})}const $table=$(this);if(!$table.data("bsTable")){const options=typeof optionsOrMethod==="object"?optionsOrMethod:{};const settings=$.extend(true,{},$.bsTable.defaults,$table.data()||{},options);if(!settings.columns||!Array.isArray(settings.columns)){settings.columns=[]}const bsTable={settings:settings};$table.data("bsTable",bsTable);buildTable($table);if(!$.bsTable.globalEventsBound){$.bsTable.globalEventsBound=true;registerGlobalTableEvents()}}if(typeof optionsOrMethod==="string"){switch(optionsOrMethod){case"showLoading":{showLoading($table)}break;case"hideLoading":{hideLoading($table)}break;case"refresh":{const arg=args.length?args[0]:null;refresh($table,arg)}break;case"refreshOptions":{const arg=args.length?args[0]:null;if(arg&&typeof arg==="object"){const setup=getSettings($table);$.extend(true,setup,arg);setSettings($table,setup);refresh($table)}}break;case"getSettings":{return getSettings($table)}break;case"setCaption":{const arg=args.length?args[0]:null;setCaption($table,arg)}break}}return $table};function setCaption($table,stringOrObject){let caption=$table.find("caption:first");const isEmpty=isValueEmpty(stringOrObject);if(isEmpty){caption.remove();return}const isString=typeof stringOrObject==="string";const isObject=typeof stringOrObject==="object";const captionText=isString?stringOrObject:isObject?stringOrObject.text:null;if(!caption.length){caption=$("<caption>",{html:captionText}).prependTo($table)}else{caption.html(captionText)}if(isObject){if(stringOrObject.hasOwnProperty("classes")&&typeof stringOrObject.classes==="string"){caption.attr("class","");caption.addClass(stringOrObject.classes)}if(stringOrObject.hasOwnProperty("onTop")&&stringOrObject.onTop===true){caption.addClass("caption-top")}else{caption.removeClass("caption-top")}}}function refresh($table,options=null,triggerRefresh=false){const settings=getSettings($table);let silent=false;let pageNumber=settings.pageNumber??1;let pageSize=settings.pageSize??10;let url=settings.url;let update=false;if(options&&typeof options==="object"){if(options.silent)silent=options.silent;if(options.pageNumber){pageNumber=Math.max(1,options.pageNumber);update=true}if(options.pageSize){pageSize=options.pageSize;update=true}if(options.url){url=options.url;update=true}}if(pageSize===0){pageNumber=1}if(update){settings.pageNumber=pageNumber;settings.pageSize=pageSize;setSettings($table,settings)}if(!silent){showLoading($table)}fetchData($table,triggerRefresh).then(()=>{triggerEvent($table,"load-success",$table.data("response"));if(typeof settings.onLoadSuccess==="function"){settings.onLoadSuccess($table.data("response"))}renderTable($table)}).catch(error=>{console.error("Fehler beim Abrufen der Daten:",error)}).finally(()=>{hideLoading($table)})}function fetchData($table,triggerRefresh=false){const settings=getSettings($table);if(settings.debug){console.groupCollapsed("fetchData");console.log("Starte fetchData für Tabelle:",$table)}return new Promise((resolve,reject)=>{if(settings.debug){console.log("Einstellungen geladen:",settings)}if(!settings.url&&!(settings.data&&Array.isArray(settings.data))){if(settings.debug){console.error("Fehler: Weder eine API-URL noch lokale Daten konfiguriert.")}reject(new Error("Neither a URL nor local data were provided."));return}let params={};if(settings.sortName&&settings.sortOrder){params.sort=settings.sortName;params.order=settings.sortOrder}const pageNumber=settings.pageNumber>0?settings.pageNumber:1;const pageSize=settings.pageSize??10;if(pageSize===0){if(settings.debug){console.log("Besonderer Fall: pageSize = 0 (Alle Datensätze anzeigen).")}params.limit=null;params.offset=0}else{const offset=(pageNumber-1)*pageSize;params.limit=pageSize;params.offset=offset;if(settings.debug){console.log("Pagination-Parameter berechnet:",params)}}const searchInput=getSearchInput($table);if(settings.search&&searchInput.length){const searchValue=searchInput.val()?.trim()||null;params.search=searchValue&&!isValueEmpty(searchValue)?searchValue:null;if(settings.debug){console.log("Suchkriterien verarbeitet:",params.search)}}if(typeof settings.queryParams==="function"){params=settings.queryParams(params);if(settings.debug){console.log("Zusätzliche Query-Parameter:",params)}}if(triggerRefresh){triggerEvent($table,"refresh",params);if(typeof settings.onRefresh==="function"){settings.onRefresh(params)}}if(Array.isArray(settings.data)){if(settings.debug){console.log("Lokale Daten erkannt. Verarbeite lokale Daten...")}let filteredData=[...settings.data];if(params.sort&&params.order){if(settings.debug){console.log(`Sortiere lokale Daten nach "${params.sort}" in Reihenfolge "${params.order}".`)}sortArrayByField(filteredData,params.sort,params.order);if(settings.debug){console.log("Daten nach Sortierung:",filteredData)}}if(params.search){if(settings.debug){console.log("Suchfilter wird angewendet: ",params.search)}filteredData=filteredData.filter(row=>Object.values(row).some(value=>value&&value.toString().toLowerCase().includes(params.search.toLowerCase())));if(settings.debug){console.log(`Gefilterte Datenanzahl nach Suchkriterien (${params.search}):`,filteredData.length)}}const totalRows=filteredData.length;if(pageSize===0||settings.pagination===false){if(settings.debug){console.log("Alle Daten für pageSize = 0 oder pagination = false zurückgeben:",totalRows,"Datensätze.")}$table.data("response",{rows:filteredData,total:totalRows});if(settings.debug){console.groupEnd()}resolve();return}const offset=params.offset||0;const start=Math.min(totalRows,offset);const end=Math.min(totalRows,start+pageSize);const rowsToRender=end-start;if(settings.debug){console.log(`Pagination-Details: Offset=${offset}, Start=${start}, End=${end}, Rows to Render=${rowsToRender}`)}if(rowsToRender<=0){if(settings.debug){console.warn("Pagination-Ergebnis ist leer. Es gibt keine Daten für diese Seite.")}$table.data("response",{rows:[],total:totalRows});if(settings.debug){console.groupEnd()}resolve();return}const slicedData=filteredData.slice(start,end);if(settings.debug){console.log("Daten für aktuelle Seite (Slice-Ergebnis):",slicedData)}$table.data("response",{rows:slicedData,total:totalRows});if(settings.debug){console.groupEnd()}resolve();return}if(settings.url){if(settings.debug){console.log("Starte Datenabruf vom Server:",settings.url,"mit Parametern:",params)}if(typeof settings.url==="function"){if(settings.debug){console.log("settings.url ist eine Funktion. Rufe Funktion mit Parametern auf.")}settings.url(params).then(response=>{const processedResponse=Array.isArray(response)?{rows:response,total:response.length}:{rows:response.rows||[],total:response.total||0};if(settings.debug){console.log("API-Antwort von Funktion erhalten:",processedResponse)}$table.data("response",processedResponse);if(settings.debug){console.groupEnd()}resolve()}).catch(error=>{if(settings.debug){console.error("Fehler bei der Verarbeitung der Funktion:",error);console.groupEnd()}reject(new Error(`Fehler bei der API-Abfrage (Funktion): ${error.message||error}`))})}else{if(settings.debug){console.log("settings.url ist ein String. Verwende $.ajax für Abruf.")}$.ajax({url:settings.url,method:"GET",data:params,dataType:"json"}).done(response=>{const processedResponse=Array.isArray(response)?{rows:response,total:response.length}:{rows:response.rows||[],total:response.total||0};if(settings.debug){console.log("API-Antwort von String-URL erhalten:",processedResponse)}$table.data("response",processedResponse);if(settings.debug){console.groupEnd()}resolve()}).fail((xhr,status,error)=>{if(settings.debug){console.error("Fehler bei der API-Abfrage (String-URL):",status,error);console.groupEnd()}reject(new Error(`Fehler bei der API-Abfrage (String-URL): ${status}, ${error}`))})}}})}function sortArrayByField(data,field,order="ASC"){const direction=order.toUpperCase()==="DESC"?-1:1;return data.sort((a,b)=>{if(a[field]==null&&b[field]==null)return 0;if(a[field]==null)return 1*direction;if(b[field]==null)return-1*direction;const aValue=typeof a[field]==="number"?a[field]:a[field].toString().toLowerCase();const bValue=typeof b[field]==="number"?b[field]:b[field].toString().toLowerCase();if(aValue>bValue)return 1*direction;if(aValue<bValue)return-1*direction;return 0})}function buildTable($table){$table.empty();const settings=getSettings($table);const wrapperId=generateRandomWrapperId();const $wrapper=$("<div>",{class:wrapperClass+" position-relative",id:wrapperId}).insertAfter($table);const isChild=getClosestWrapper($wrapper).length>0?"true":"false";$wrapper.attr("data-child",isChild);$table.attr("data-wrapper",wrapperId);const tableClasses=[];if(typeof settings.classes==="string"){settings.classes.split(" ").forEach(className=>{const name=className.trim();if(!isValueEmpty(name)){tableClasses.push(className)}})}else if(typeof settings.classes==="object"&&settings.classes.hasOwnProperty("table")){settings.classes.table.split(" ").forEach(className=>{const name=className.trim();if(!isValueEmpty(name)){tableClasses.push(className)}})}$table.addClass(tableClasses.join(" "));$table.appendTo($wrapper);setCaption($table,settings.caption);const $tableTopContainer=buildTableTop($table).prependTo($wrapper);const $tableBottomContainer=buildTableBottom($table).appendTo($wrapper);$("<thead></thead>").appendTo($table);$("<tbody></tbody>").appendTo($table);$("<tfoot></tfoot>").appendTo($table);refresh($table)}function buildTableBottom($table){const $wrapper=getWrapper($table);const settings=getSettings($table);let flexClass="flex-row";if(!["right","end"].includes(settings.paginationHAlign)){flexClass+=" flex-row-reverse"}let gapClass="";if(settings.pagination===true&&["bottom","both"].includes(settings.paginationVAlign)){gapClass="gap-2 py-2"}const template=`
            <div class="d-flex flex-column ${gapClass}" data-role="tableBottomContainer">
                <div class="d-flex justify-content-between ${flexClass}">
                    <div class="${wrapperPaginationDetailsClass}"></div>
                    <div class="${wrapperPaginationClass} bottom"></div>
                </div>
            </div>`;return $(template)}function buildTableTop($table){const $wrapper=getWrapper($table);const settings=getSettings($table);let flexClass="flex-row";if(!["right","end"].includes(settings.paginationHAlign)){flexClass+=" flex-row-reverse"}let gapClass="";if(settings.pagination===true&&["top","both"].includes(settings.paginationVAlign)||settings.search===true||settings.toolbar||settings.showRefresh){gapClass="gap-2 py-2"}const template=`
            <div class="d-flex flex-column ${gapClass}" data-role="tableTopContainer">
                <div class="d-flex justify-content-end align-items-end">
                    <div class="d-flex bs-table-toolbar me-auto">
                    </div>
                    <div class="d-flex ${wrapperSearchClass}">
                    </div>
                    <div class="btn-group bs-table-buttons">
                    </div>
                </div>
                <div class="d-flex justify-content-between ${flexClass}">
                    <div class="${wrapperPaginationDetailsClass}"></div>
                    <div class="${wrapperPaginationClass} top"></div>
                </div>
            </div>`;const $tableTopContainer=$(template);const $toolbarContainer=$tableTopContainer.find(".bs-table-toolbar");const $searchWrapper=$tableTopContainer.find("."+wrapperSearchClass);const $btnContainer=$tableTopContainer.find(".bs-table-buttons");if(settings.toolbar&&$(settings.toolbar).length>0){$(settings.toolbar).prependTo($toolbarContainer)}if(settings.search===true){const $searchInputGroup=$(`
    <div class="input-group">
        <span class="input-group-text"><i class="${settings.icons.search}"></i></span>
        <input type="search" class="form-control ${inputSearchClass}" placeholder="...">
    </div>
`);$searchInputGroup.appendTo($searchWrapper)}if(settings.showRefresh){const $refreshButton=$(`<button>`,{class:"btn btn-secondary",html:`<i class="${settings.icons.refresh}"></i>`,title:"Refresh","data-role":"refresh"}).appendTo($btnContainer)}return $tableTopContainer}function hideLoading($table){const $overlay=getOverlay($table);if(!$overlay.length)return;$overlay.stop().animate({opacity:0},100,function(){$(this).remove()})}function showLoading($table){const settings=getSettings($table);const wrapper=getWrapper($table);hideLoading($table);const $overlay=$("<div>",{class:wrapperOverlayClass+" position-absolute top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center bg-body",css:{zIndex:4,opacity:0}}).appendTo(wrapper);const $content=$(`
<div class="spinner-border" style="width: 3rem; height: 3rem;" role="status">
  <span class="visually-hidden">Loading...</span>
</div>`).appendTo($overlay);$overlay.animate({opacity:.75},100)}function renderTable($table){const settings=getSettings($table);if(settings.debug){console.groupCollapsed("Render Table")}const wrapper=getWrapper($table);const response=$table.data("response")||{rows:[],total:0};if(settings.debug){console.log("Response:",response)}const totalRows=response.total||(response.rows?response.rows.length:0);const pageSize=settings.pageSize;const pageNumber=settings.pageNumber;let currentPageData=response.rows;if(settings.debug){console.log("Total Rows:",totalRows);console.log("Page Size:",pageSize);console.log("Page Number:",pageNumber);console.log("Rows to Render:",currentPageData.length,currentPageData);console.groupEnd()}if(settings.columns&&settings.columns.length){buildTableHeader($table,settings.columns);buildTableBody($table,currentPageData);buildTableFooter($table,settings.columns,response.rows)}const $topPaginationContainer=getPaginationContainer($table,true).empty();const $bottomPaginationContainer=getPaginationContainer($table,false).empty();const $tableTopContainer=getTableTopContainer($table);const $btnContainer=$tableTopContainer.find(".bs-table-buttons:first");if(isValueEmpty(settings.pageList)){$btnContainer.find('[data-role="tablePaginationPageSize"]:first').remove()}else{const $pageListDropdown=buildPagelistDropdown($table,totalRows);if($btnContainer.find('[data-role="tablePaginationPageSize"]:first').length>0){$btnContainer.find('[data-role="tablePaginationPageSize"]:first').replaceWith($pageListDropdown)}else{$pageListDropdown.prependTo($btnContainer)}}if($btnContainer.find(".btn").length&&settings.search===true){$btnContainer.addClass("ms-2")}else{$btnContainer.removeClass("ms-2")}if(settings.pagination&&pageSize!==0){const $wrapper=getWrapper($table);const $paginationHtml=createPagination($table,totalRows);if(settings.paginationVAlign==="top"||settings.paginationVAlign==="both"){$topPaginationContainer.append($paginationHtml.clone())}if(settings.paginationVAlign==="bottom"||settings.paginationVAlign==="both"){$bottomPaginationContainer.append($paginationHtml.clone())}}}function createPaginationDetails($table,totalRows){const settings=getSettings($table);const pageSize=settings.pageSize||totalRows;const currentPage=settings.pageNumber||1;const startRow=totalRows===0?0:(currentPage-1)*pageSize+1;const endRow=Math.min(totalRows,currentPage*pageSize);const $paginationDetailWrapper=$("<div>",{class:"d-flex align-items-center","data-role":"tablePaginationPageSize"});const $paginationText=$("<span>",{class:"mx-2"}).html(`<div class="badge text-bg-secondary">${startRow} - ${endRow} / ${totalRows}</div>`);const $dropdownToggle=$("<button>",{class:"btn btn-secondary dropdown-toggle me-1",type:"button",id:"dropdownPaginationPageSize","data-bs-toggle":"dropdown","aria-expanded":"false"}).html((pageSize===totalRows?"All":pageSize)+' <i class="bi bi-list-columns-reverse"></i>');const $dropdownMenu=$("<ul>",{class:"dropdown-menu","aria-labelledby":"dropdownPaginationPageSize"});const $rowsPerPageText=$("<span>").text("");$paginationDetailWrapper.append($dropdownToggle,$dropdownMenu,$paginationText);return $paginationDetailWrapper}function buildPagelistDropdown($table,totalRows){const settings=getSettings($table);const pageSize=settings.pageSize||totalRows;const currentPage=settings.pageNumber||1;const startRow=totalRows===0?0:(currentPage-1)*pageSize+1;const endRow=Math.min(totalRows,currentPage*pageSize);const $dropdownWrapper=$("<div>",{class:"dropdown btn-group","data-role":"tablePaginationPageSize"});const $dropdownToggle=$("<button>",{class:"btn btn-secondary dropdown-toggle",type:"button",id:"dropdownPaginationPageSize","data-bs-toggle":"dropdown","aria-expanded":"false"}).html((pageSize===totalRows?"All":pageSize)+' <i class="bi bi-list-columns-reverse"></i>');const $dropdownMenu=$("<ul>",{class:"dropdown-menu dropdown-menu-end","aria-labelledby":"dropdownPaginationPageSize"});settings.pageList.filter(page=>page==="All"||page<totalRows).forEach(page=>{const value=page==="All"?0:page;const isAll=value===0;const isActive=isAll&&pageSize===0||page===pageSize;const text=isAll?"All":page;const $dropdownItem=$("<li>").append($("<a>",{class:`dropdown-item ${isActive?"active":""}`,href:"#","data-page":value}).text(text));$dropdownMenu.append($dropdownItem)});$dropdownWrapper.append($dropdownToggle,$dropdownMenu);return $dropdownWrapper}function createPagination($table,totalRows){const settings=getSettings($table);const totalPages=Math.ceil(totalRows/settings.pageSize);const currentPage=settings.pageNumber||1;const $paginationWrapper=$("<nav></nav>",{"data-role":"tablePagination"});const $paginationList=$("<ul></ul>",{class:"pagination justify-content-center m-0"}).appendTo($paginationWrapper);const $prevItem=$("<li></li>",{"data-role":"previous",class:`page-item ${currentPage===1?"disabled":""}`}).appendTo($paginationList);$("<a></a>",{class:"page-link",href:"#",tabindex:currentPage===1?"-1":"","aria-disabled":currentPage===1?"true":"false",html:`<i class="${settings.icons.paginationprev}"></i>`}).appendTo($prevItem).on("click",function(e){e.preventDefault();if(currentPage>1){settings.pageNumber=currentPage-1;setSettings($table,settings);refresh($table)}});const visiblePages=calculateVisiblePages(totalPages,currentPage);visiblePages.forEach(page=>{if(page==="..."){$("<li></li>",{class:"page-item disabled"}).append($("<a></a>",{class:"page-link",text:"..."})).appendTo($paginationList)}else{const $pageItem=$("<li></li>",{class:`page-item ${page===currentPage?"active":""}`}).appendTo($paginationList);$("<a></a>",{class:"page-link",href:"#",text:page}).appendTo($pageItem).on("click",function(e){e.preventDefault();if(page!==currentPage){settings.pageNumber=page;setSettings($table,settings);refresh($table)}})}});const $nextItem=$("<li></li>",{class:`page-item ${currentPage===totalPages?"disabled":""}`}).appendTo($paginationList);$("<a></a>",{"data-role":"next",class:"page-link",href:"#",tabindex:currentPage===totalPages?"-1":"","aria-disabled":currentPage===totalPages?"true":"false",html:`<i class="${settings.icons.paginationNext}"></i>`}).appendTo($nextItem).on("click",function(e){e.preventDefault();if(currentPage<totalPages){settings.pageNumber=currentPage+1;setSettings($table,settings);refresh($table)}});return $paginationWrapper}function calculateVisiblePages(totalPages,currentPage){const visiblePages=[];if(currentPage<=4){for(let i=1;i<=Math.min(5,totalPages);i++){visiblePages.push(i)}if(totalPages>5){visiblePages.push("...");visiblePages.push(totalPages)}}else if(currentPage>=totalPages-3){visiblePages.push(1);if(totalPages>5){visiblePages.push("...")}for(let i=Math.max(totalPages-4,1);i<=totalPages;i++){visiblePages.push(i)}}else{visiblePages.push(1);visiblePages.push("...");visiblePages.push(currentPage-1);visiblePages.push(currentPage);visiblePages.push(currentPage+1);visiblePages.push("...");visiblePages.push(totalPages)}return visiblePages}function buildTableHeader($table,columns){const settings=getSettings($table);const hasCheckbox=columns.some(column=>column.checkbox===true);const headerClasses=[];if(settings.showHeader===false){headerClasses.push("d-none")}if(typeof settings.classes==="object"&&typeof settings.classes.thead==="object"){settings.classes.thead.split(" ").forEach(className=>{const name=className.trim();if(!isValueEmpty(name)){headerClasses.push(className)}})}if(columns&&columns.length){const $thead=$table.find("thead").empty().addClass(headerClasses.join(" "));const $tr=$("<tr></tr>").appendTo($thead);buildCheckboxOrRadio($table,$tr,null);columns.forEach(column=>{if(column.visible===false){return}const html=[`<div class="d-flex align-items-center justify-content-between">`,`<span>${column.title??""}</span>`];if(column.sortable===true){html.push(`<span><i class="bs-table-icon"></i></span>`)}html.push(`</div>`);const order=column.field===settings.sortName?settings.sortOrder??"":"";const $th=$("<th>",{"data-sortable":column.sortable===true?"true":"false","data-field":column.field,"data-order":order,html:html.join("")}).appendTo($tr);if(column.sortable===true){$th.css("cursor","pointer")}const icon=getIconBySortOrder($table,order);$th.find(".bs-table-icon").addClass(icon);if(column.width){$th.css("width",column.width)}})}}function getIconBySortOrder($table,sortOrder){const settings=getSettings($table);if(sortOrder==="asc"){return settings.icons.sortAsc}if(sortOrder==="desc"){return settings.icons.sortDesc}return settings.icons.sortNone}function buildTableFooter($table,columns,data){const settings=getSettings($table);if(settings.showFooter===false){return}let tableClasses="";if(typeof settings.classes==="object"){tableClasses=settings.classes.tfoot}const $tfoot=$table.find("tfoot").empty().addClass(tableClasses);if(columns&&columns.length){const $tr=$("<tr></tr>").appendTo($tfoot);const columnWithInput=columns.find(column=>column.checkbox===true)||columns.find(column=>column.radio===true);if(columnWithInput){$("<td></td>").appendTo($tr)}columns.forEach(column=>{if(column.visible===false){return}let value="";if(typeof column.footerFormatter==="function"){value=column.footerFormatter(data)}const $td=$("<td>",{html:value}).appendTo($tr)})}triggerEvent($table,"post-footer",$tfoot,$table);if(typeof settings.onPostFooter==="function"){settings.onPostFooter($tfoot,$table)}}function buildTableBody($table,rows){const settings=getSettings($table);triggerEvent($table,"pre-body",rows,$table);if(typeof settings.onPreBody==="function"){settings.onPreBody(rows,$table)}const hasColumns=settings.columns&&settings.columns.length;const columns=hasColumns?settings.columns:[];const hasCheckbox=columns.some(column=>column.checkbox===true);const $tbody=$table.find("tbody").empty();if(rows&&rows.length){let tableClasses="";if(typeof settings.classes==="object"){tableClasses=settings.classes.tbody}$tbody.addClass(tableClasses);let trIndex=0;rows.forEach(row=>{const $tr=$("<tr>",{"data-index":trIndex}).appendTo($tbody);$tr.data("row",row);if(typeof settings.rowStyle==="function"){settings.rowStyle(row,trIndex,$tr)}if(hasColumns){const isInputSet=buildCheckboxOrRadio($table,$tr,row);settings.columns.forEach(column=>{if(column.visible===false){return}buildTableBodyTd(column,row,$tr)})}trIndex++})}else{const $tr=$("<tr></tr>").appendTo($tbody);const $td=$("<td>",{colspan:getCountColumns($table),class:"text-center",html:settings.formatNoMatches()}).appendTo($tr)}triggerEvent($table,"post-body",rows,$table);if(typeof settings.onPostBody==="function"){settings.onPostBody(rows,$table)}}function buildCheckboxOrRadio($table,$tr,row=null){const settings=getSettings($table);const defaultIdField=settings.idField;const columns=settings.columns;const forHeader=isValueEmpty(row);if(!columns||!columns.length||!Array.isArray(columns)){return false}const column=columns.find(column=>column.checkbox===true)||columns.find(column=>column.radio===true);if(!column||!column.field&&!defaultIdField){return false}const field=column.field??defaultIdField;const $thCheckbox=$(forHeader?"<th></th>":"<td></td>",{class:"text-center align-middle","data-role":"tableCellCheckbox"}).appendTo($tr);const isCheckbox=column.checkbox===true;const inputType=isCheckbox||!isCheckbox&&forHeader?"checkbox":"radio";if(forHeader){$thCheckbox.css("width","50px")}const $thCheckboxWrapper=$("<div></div>",{class:"form-check form-switch"}).appendTo($thCheckbox);const dataRole=forHeader?isCheckbox?"tableHeaderCheckbox":"tableHeaderRadio":isCheckbox?"tableCheckbox":"tableRadio";const $thCheckboxInput=$("<input>",{id:generateRandomWrapperId(`bs_table_${inputType}_`),"data-role":dataRole,class:"form-check-input float-none",type:inputType}).appendTo($thCheckboxWrapper);if(!isCheckbox&&forHeader){$thCheckboxInput.prop("disabled",true)}const $thCheckboxLabel=$("<label></label>",{class:"form-check-label d-none m-0 p-0",for:$thCheckboxInput.attr("id"),html:forHeader?"":column.title}).appendTo($thCheckboxWrapper);if(row){$thCheckboxInput.attr("value",row[field]??null);if(isCheckbox){$thCheckboxInput.attr("name",`${field}[]`)}else{$thCheckboxInput.attr("name",field)}}return true}function getCountColumns($table,onlyVisible=true){const settings=getSettings($table);if(!settings.columns||!settings.columns.length){return 0}return settings.columns.filter(column=>!onlyVisible||column.visible!==false).length}function buildTableBodyTd(column,row,$tr){if(column.field){const trIndex=$tr.data("index");let classList=[];if(column.class){column.class.split(" ").forEach(className=>{classList.push(className)})}if(column.align){classList.push("text-"+column.align)}if(column.valign){classList.push("align-"+column.valign)}const $td=$("<td>",{class:classList.join(" ")}).appendTo($tr);$td.data("column",column);$td.data("trIndex",trIndex);let value=row[column.field]??" - ";if(column.formatter&&typeof column.formatter==="function"){const customValue=column.formatter(value,row,trIndex,$td);if(typeof customValue==="string"&&customValue.trim()!==""&&$td.html().trim()===""){value=customValue}}if($td.html().trim()===""){$td.html(value)}if(column.events){for(const[eventSelector,eventHandler]of Object.entries(column.events)){const splitEvent=eventSelector.split(" ");const selector=splitEvent.pop();const eventTypes=splitEvent.join(" ");if(selector){$td.on(eventTypes,selector,function(e){eventHandler(e,row[column.field]??null,row,trIndex)})}else{$td.on(eventTypes,function(e){eventHandler(e,row[column.field]??null,row,trIndex)})}}}}}function getSettings($table){return $table.data("bsTable").settings}function getWrapper($table){return $table.closest(`.${wrapperClass}`)}function getClosestWrapper($element){return $element.closest(`.${wrapperClass}`)}function getClosestWrapperId($element){return $element.closest(`.${wrapperClass}`).attr("id")}function getTableBottomContainer($table){const $wrapper=getWrapper($table);return $wrapper.find(`[data-role="tableBottomContainer"]`).first()}function getTableTopContainer($table){const $wrapper=getWrapper($table);return $wrapper.find(`[data-role="tableTopContainer"]`).first()}function getPaginationContainer($table,top){if(top){return getTableTopContainer($table).find("."+wrapperPaginationClass)}else{return getTableBottomContainer($table).find("."+wrapperPaginationClass)}}function getPaginationDetailsContainer($table){const $wrapper=getWrapper($table);const $pagination=$wrapper.find(`.${wrapperPaginationDetailsClass}`).filter(function(){return getClosestWrapper($(this))[0]===$wrapper[0]}).first();return $pagination.length>0?$pagination:$()}function getSearchInput($table){const $wrapper=getWrapper($table);const $searchInput=$wrapper.find("."+inputSearchClass).filter(function(){return getClosestWrapper($(this))[0]===$wrapper[0]}).first();return $searchInput.length>0?$searchInput:$()}function generateRandomWrapperId(prefix="bs_table_wrapper_"){const guid="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(char){const random=Math.random()*16|0;const value=char==="x"?random:random&3|8;return value.toString(16)});const modifiedGuid=guid.replace(/-/g,"_");return prefix+modifiedGuid}function getOverlay($table){const $wrapper=getWrapper($table);const $overlay=$wrapper.find("."+wrapperOverlayClass).filter(function(){return getClosestWrapper($(this))[0]===$wrapper[0]}).first();return $overlay.length>0?$overlay:$()}function setSettings($table,settings){const data=$table.data("bsTable");if(data){data.settings=settings}$table.data("bsTable",data)}function isValueEmpty(value){if(value===null||value===undefined){return true}if(Array.isArray(value)){return value.length===0}if(typeof value==="string"){return value.trim().length===0}return false}function handleSortOnTheadTh($th){const wrapper=getClosestWrapper($th);const $table=getTableByWrapperId(wrapper.attr("id"));const settings=getSettings($table);const allSortableHeaders=$table.find('thead:first th[data-sortable="true"]');const filteredHeaders=allSortableHeaders.not($th);filteredHeaders.each(function(i,el){const $otherTh=$(el);$otherTh.attr("data-order","");const $icon=$otherTh.find("i.bs-table-icon");$icon.removeClass(settings.icons.sortNone);$icon.removeClass(settings.icons.sortAsc);$icon.removeClass(settings.icons.sortDesc);$icon.addClass(settings.icons.sortNone)});if($th.length>0){let order=$th.attr("data-order");if(order==="asc"){order="desc"}else if(order==="desc"){order=""}else{order="asc"}const $iconCurrent=$th.find("i.bs-table-icon");const field=$th.attr("data-field");$iconCurrent.removeClass(settings.icons.sortNone);$iconCurrent.removeClass(settings.icons.sortAsc);$iconCurrent.removeClass(settings.icons.sortDesc);$th.attr("data-order",order);settings.sortOrder=order===""?null:order;settings.sortName=field;settings.pageNumber=1;switch(order){case"asc":{$iconCurrent.addClass(settings.icons.sortAsc)}break;case"desc":{$iconCurrent.addClass(settings.icons.sortDesc)}break;default:{$iconCurrent.addClass(settings.icons.sortNone)}}}else{settings.sortOrder=null;settings.sortName=null}triggerEvent($table,"sort",settings.sortName,settings.sortOrder);if(typeof settings.onSort==="function"){settings.onSort(settings.sortName,settings.sortOrder)}setSettings($table,settings);refresh($table)}function onClickCellAndRow($td){if($td.attr("data-role")==="tableCellCheckbox"){return}const $table=$td.closest("table");const settings=getSettings($table);const column=$td.data("column");const $tr=$td.closest("tr");const row=$tr.data("row");const value=row[column.field]??null;const trIndex=$td.data("trIndex");triggerEvent($table,"click-row",row,$tr,column.field);if(typeof settings.onClickRow==="function"){settings.onClickRow(row,$tr,column.field)}triggerEvent($table,"click-cell",column.field,value,row,$td);if(typeof settings.onClickCell==="function"){settings.onClickCell(column.field,value,row,$td)}}function triggerEvent($table,eventName,...args){const targetTable=$table[0];const settings=getSettings($table);const isSubTable=$table.closest(`.${wrapperClass}[data-child="true"]`).length>0;const hasSubTables=getClosestWrapper($table).find(`.${wrapperClass}[data-child="true"]`).length>0;const bsTableDatas={table:targetTable,settings:settings,isChildTable:isSubTable,hasChildTables:hasSubTables};const event=$.Event(eventName+namespace,{target:targetTable,bsTable:bsTableDatas});$table.trigger(event,args);event.stopPropagation();if(eventName!=="all"){const allEvent=$.Event(`all${namespace}`,{target:targetTable});$table.trigger(allEvent,[eventName+namespace,...args]);allEvent.stopPropagation()}}function getTableByWrapperId(wrapperId){return $(`table[data-wrapper="${wrapperId}"`)}function handleClickOnPaginationSize($table,$a){const settings=getSettings($table);const response=$table.data("response");settings.pageSize=parseInt($a.data("page"));const totalRows=response.total;const maxPageNumber=Math.ceil(totalRows/settings.pageSize);if(settings.pageNumber>maxPageNumber){console.warn(`Page ${settings.pageNumber} is invalid. Falling back to last page (${maxPageNumber}).`);settings.pageNumber=maxPageNumber}setSettings($table,settings);refresh($table)}function handleCheckboxChange($checkbox){if(!$checkbox.length)return;const wrapper=getClosestWrapper($checkbox);const table=getTableByWrapperId(wrapper.attr("id"));const $tr=$checkbox.closest("tr");const isChecked=$checkbox.is(":checked");const settings=getSettings(table);const row=$tr.data("row");if(isChecked){triggerEvent(table,"check",row,$checkbox);if(typeof settings.onCheck==="function"){settings.onCheck(row,$checkbox)}}else{triggerEvent(table,"uncheck",row,$checkbox);if(typeof settings.onUncheck==="function"){settings.onUncheck(row,$checkbox)}}$tr.toggleClass("table-active")}function handleRadiosByRadioChange($checkbox){if(!$checkbox.length)return;const wrapper=getClosestWrapper($checkbox);const table=getTableByWrapperId(wrapper.attr("id"));const $tr=$checkbox.closest("tr");const row=$tr.data("row");const value=$checkbox.attr("value");const settings=getSettings(table);const headerCheckbox=table.find(`[data-role="tableHeaderRadio"]:first`);headerCheckbox.prop("checked",true).prop("disabled",false);table.find('[data-role="tableRadio"]').each(function(_,el){const radio=$(el);if(getClosestWrapper(radio)[0]===wrapper[0]){const radioTr=radio.closest("tr");radioTr.removeClass("table-active");if(radio.is(":checked")){radioTr.addClass("table-active");triggerEvent(table,"check",radioTr.data("row"),radio);if(typeof settings.onCheck==="function"){settings.onCheck(radioTr.data("row"),radio)}}}})}function handleCheckOnOrNone($checkbox){if(!$checkbox.length)return;const wrapper=getClosestWrapper($checkbox);const table=getTableByWrapperId(wrapper.attr("id"));const $tr=$checkbox.closest("tr");const settings=getSettings(table);const isChecked=$checkbox.prop("checked");table.find('[data-role="tableCheckbox"]').each(function(_,el){const radio=$(el);if(getClosestWrapper(radio)[0]===wrapper[0]){radio.prop("checked",isChecked);if(isChecked){radio.closest("tr").addClass("table-active")}else{radio.closest("tr").removeClass("table-active")}}});if(isChecked){triggerEvent(table,"check-all");if(typeof settings.onCheckAll==="function"){settings.onCheckAll()}}else{triggerEvent(table,"uncheck-all");if(typeof settings.onUncheckAll==="function"){settings.onUncheckAll()}}}function performSearch(wrapper){const table=getTableByWrapperId(wrapper.attr("id"));const settings=getSettings(table);settings.pageNumber=1;setSettings(table,settings);refresh(table)}function handleUncheckRadios($checkbox){if(!$checkbox.length)return;const wrapper=getClosestWrapper($checkbox);const $tr=$checkbox.closest("tr");const table=getTableByWrapperId(wrapper.attr("id"));const settings=getSettings(table);table.find('[data-role="tableRadio"]').each(function(_,el){const radio=$(el);if(getClosestWrapper(radio)[0]===wrapper[0]){radio.prop("checked",false);radio.closest("tr").removeClass("table-active")}});triggerEvent(table,"uncheck-all");if(typeof settings.onUncheckAll==="function"){settings.onUncheckAll()}$checkbox.prop("disabled",true)}function registerGlobalTableEvents(){let searchTimeout;function getRelevantElement(e,selector){const $el=e.target.tagName===selector.toUpperCase()?$(e.target):$(e.target).closest(selector);if(!$el.length){return null}return $el}$("."+wrapperClass).on(["click"+namespace,"change"+namespace,"touchstart"+namespace,"mousenter"+namespace].join(" "),'[data-child="true"]',function(e){e.stopPropagation();e.stopImmediatePropagation()}).on("click"+namespace,"td",function(e){e.stopPropagation();e.stopImmediatePropagation();const $td=$(e.currentTarget);onClickCellAndRow($td)}).on("change"+namespace,'thead [data-role="tableHeaderRadio"]',function(e){e.stopPropagation();e.stopImmediatePropagation();const $checkbox=$(e.currentTarget);handleUncheckRadios($checkbox)}).on("change"+namespace,`thead [data-role="tableHeaderCheckbox"]`,function(e){e.stopPropagation();e.stopImmediatePropagation();const $checkbox=$(e.currentTarget);handleCheckOnOrNone($checkbox)}).on("change"+namespace,`table tbody [data-role="tableRadio"]`,function(e){e.stopPropagation();e.stopImmediatePropagation();const $checkbox=$(e.currentTarget);handleRadiosByRadioChange($checkbox)}).on("change"+namespace,`tbody [data-role="tableCheckbox"]`,function(e){e.stopPropagation();e.stopImmediatePropagation();const $checkbox=$(e.currentTarget);handleCheckboxChange($checkbox)}).on("click"+namespace,`thead th[data-sortable="true"]`,function(e){e.stopPropagation();e.stopImmediatePropagation();const $th=$(e.currentTarget);handleSortOnTheadTh($th)}).on("click"+namespace,`[data-role="tablePaginationPageSize"] .dropdown-item`,function(e){e.preventDefault();e.stopPropagation();e.stopImmediatePropagation();const $a=$(e.currentTarget);if(!$a.length)return;const wrapper=getClosestWrapper($a);const table=getTableByWrapperId(wrapper.attr("id"));handleClickOnPaginationSize(table,$a)}).on("click"+namespace,`[data-role="refresh"]`,function(e){e.preventDefault();e.stopPropagation();e.stopImmediatePropagation();const $btn=$(e.currentTarget);if(!$btn.length)return;const $wrapper=getClosestWrapper($btn);const table=getTableByWrapperId($wrapper.attr("id"));refresh(table,null,true)}).on("input"+namespace,`.${inputSearchClass}`,function(e){e.stopPropagation();e.stopImmediatePropagation();const $searchField=$(e.currentTarget);if(!$searchField.length)return;const wrapper=getClosestWrapper($searchField);clearTimeout(searchTimeout);searchTimeout=setTimeout(()=>{performSearch(wrapper)},600);if(e.key==="Enter"){e.preventDefault();clearTimeout(searchTimeout);performSearch(wrapper)}}).on("click"+namespace,`.${wrapperPaginationClass} .page-link`,function(e){e.preventDefault();e.stopPropagation();e.stopImmediatePropagation();const $pageLink=$(e.currentTarget);if(!$pageLink.length)return;const wrapper=getClosestWrapper($pageLink);const table=getTableByWrapperId(wrapper.attr("id"));const settings=getSettings(table);const response=table.data("response")||{rows:[],total:0};const totalPages=Math.ceil(response.total/settings.pageSize);if($pageLink.parent().hasClass("disabled")||$pageLink.parent().hasClass("active")){return}const action=$pageLink.attr("data-role")||$pageLink.html().toLowerCase().trim();if(action.includes("previous")||action.includes("left")){settings.pageNumber=Math.max(1,settings.pageNumber-1)}else if(action.includes("next")||action.includes("right")){settings.pageNumber=Math.min(totalPages,settings.pageNumber+1)}else{const pageNum=parseInt($pageLink.text().trim(),10);if(!isNaN(pageNum)){settings.pageNumber=pageNum}}setSettings(table,settings);refresh(table)})}})(jQuery);