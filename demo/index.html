<!doctype html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>$.fn.bsTable</title>
    <link href="../vendor/twbs/bootstrap-icons/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="../vendor/twbs/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container py-5">
    <h1>$.fn.bsTable</h1>
    <hr>
    <div class="" id="toolbar_table"><h2 class="mb-0">Demo Table</h2></div>
    <table id="table"></table>
</div>
<script src="../vendor/components/jquery/jquery.min.js"></script>
<script src="../vendor/twbs/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
<script src="../dist/bs-table.js"></script>
<!--suppress JSUnresolvedReference -->
<script>
    $(document).ready(function () {

        async function getDatas() {
            return new Promise((resolve, reject) => {
                $.getJSON('data.json', function (data) {
                    resolve(data)
                });
            })
        }

        // Ausgelagerte Funktion
        async function processData(data, params) {
            // 1. Zufällige Verzögerung zwischen 500ms und 3000ms
            const delay = Math.floor(Math.random() * (1000 - 20 + 1)) + 20; // Zufallswert zwischen 500 und 3000
            await new Promise(resolve => setTimeout(resolve, delay));


            // 2. Filtere die Daten basierend auf der Suche
            if (params.search) {
                const searchValue = params.search.toLowerCase(); // Suche case-insensitive
                data = data.filter(row =>
                    Object.values(row).some(value =>
                        value && value.toString().toLowerCase().includes(searchValue)
                    )
                );
            }

            // 3. Sortiere die Daten, wenn `params.sort` und `params.order` angegeben sind
            if (params.sort && params.order) {
                data = data.sort((a, b) => {
                    const fieldA = a[params.sort] ?? ""; // Fallback für leere Felder
                    const fieldB = b[params.sort] ?? "";

                    if (params.order === "asc") {
                        return fieldA > fieldB ? 1 : fieldA < fieldB ? -1 : 0;
                    } else if (params.order === "desc") {
                        return fieldA < fieldB ? 1 : fieldA > fieldB ? -1 : 0;
                    }

                    return 0;
                });
            }

            // 4. Pagination anwenden (limit und offset)
            const offset = params.offset ?? 0;
            const limit = params.limit ?? data.length;
            const result = {
                total: data.length, // Die Gesamtanzahl nach Filterung und Sortierung
                rows: data.slice(offset, offset + limit) // Ausschnitt der Daten
            };

            return result;
        }

        getDatas().then(data => {
            const table = $('#table');
            table.bsTable({
                classes: {
                    table: 'table align-top table-sm table-bordered table-primary mb-0',
                    thead: 'table-dark h4 text-uppercase',
                    tbody: 'table-group-divider',
                    tfoot: 'table-warning',
                },
                toolbar: '#toolbar_table',
                showFooter: true,
                showHeader: true,
                showColumns: true,
                sortName: 'id',
                sortOrder: 'asc',
                search: true,
                pageSize: 10,
                pagination: true,
                data: data,
                idField: 'id',
                paginationVAlign: 'both',
                paginationHAlign: 'end',
                sidePagination: 'client',
                caption: {
                    text: "Table with local datas",
                },
                onPostBody: function () {
                    const subTable = table.find('table').first()
                    if (!subTable.length) {
                        return;
                    }
                    subTable.bsTable({
                        classes: {
                            table: 'table align-top table-sm table-danger mb-0',
                            tbody: 'table-group-divider',
                            tfoot: 'table-info',
                        },
                        url: function (params) {
                            return getDatas().then(data => {
                                return processData(data, params);
                            });
                        },
                        caption: {
                            classes: 'text-bg-dark px-2 bg-gradient',
                            text: "Table with remote datas fetched from url as function",
                            onTop: true,
                        },
                        debug: false,
                        pagination: true,
                        search: true,
                        sidePagination: 'server',
                        paginationVAlign: 'bottom',
                        paginationHAlign: 'end',
                        showFooter: true,
                        showRefresh: true,
                        idField: 'id',
                        pageSize: 5,
                        columns: [{
                            radio: true,
                        }, {
                            sortable: true,
                            title: 'Title2',
                            field: 'title'
                        }, {
                            title: 'Price',
                            field: 'price',
                            align: 'right',
                            falign: 'right',
                            halign: 'right',
                            sortable: true,
                            formatter: formatMoney,
                            footerFormatter(dataRow) {
                                const sumOfIds = dataRow.reduce((sum, row) => {
                                    return sum + (row.price || 0); // Füge die ID hinzu, falls sie existiert, sonst 0
                                }, 0);
                                return '<span class="text-nowrap">Sum : ' + formatMoney(sumOfIds) + '</span>';
                            }
                        },]
                    });
                },
                columns: [
                    {
                        checkbox: true,
                    },
                    {
                        field: 'id',
                        title: 'ID',
                        align: 'center',
                        valign: 'middle',
                        visible: true,
                        sortable: true,
                    },
                    {
                        sortable: true,
                        title: 'Title',
                        field: 'title',
                    },
                    {
                        sortable: true,
                        class: '',
                        title: 'Body',
                        field: 'body',
                    }, {
                        field: 'price',
                        align: 'right',
                        formatter: formatMoney,
                        footerFormatter(dataRow) {
                            const sumOfIds = dataRow.reduce((sum, row) => {
                                return sum + (row.price || 0); // Füge die ID hinzu, falls sie existiert, sonst 0
                            }, 0);

                            return '<span class="text-nowrap">Sum : ' + formatMoney(sumOfIds) + '</span>';
                        }
                    },
                    {
                        class: 'p-3',
                        title: '',
                        visible: true,
                        field: 'actions',
                        width: '50%',
                        formatter: function (value, row, index, $td) {
                            if (index === 0)
                                $('<table id="test" data-toolbar="#sub_table_toolbar"></table>').appendTo($td);
                        }
                    }
                ]
            });

            $(document).on('post-body.bs.table', '#table', function (e, ...args) {

                if (e.target !== e.currentTarget) {
                    console.log('[DEBUG] Event ignoriert, da Subtable: ' + $(e.target).attr('id'));
                    return;
                }
                console.log(e.bsTable)
                console.log('Tabelle mit id #' + $(e.target).attr('id') + ' hat gefeuert');
                // console.table(args);
            });


            // Direkte Bindung des Event-Handlers an die Tabelle
            // $(document).on('all.bs.table', '#table', function (e, ...args) {
            //     // Prüfen, ob das Event NICHT von einer verschachtelten Tabelle kommt
            //     if (e.target !== e.currentTarget) {
            //         // Ignorieren, wenn das Event von einer Subtable kommt
            //         return;
            //     }
            //     console.log(...args);
            //     const message = `${args[0]}`;
            //     showToast(message, "primary");
            // });


            // Funktion zum Erstellen eines Toasts
            function showToast(message, type = "info") {
                const toastContainer = $("#toast-container");

                // Falls der Toast-Container nicht vorhanden ist, erstellen wir ihn
                if (!toastContainer.length) {
                    $("body").append(`
            <div id="toast-container" class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080;">
            </div>
        `);
                }

                // Hinzufügen des Toasts
                const toastHTML = `
        <div class="toast align-items-center text-bg-${type} border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    `;

                // $(toastHTML).appendTo(toastContainer);
                $("#toast-container").append(toastHTML);

                // Bootstrap-Toast initialisieren und anzeigen
                const toastElement = $("#toast-container .toast").last()[0];
                const bsToast = new bootstrap.Toast(toastElement, {delay: 6000});
                bsToast.show();
            }

            function formatMoney(amount) {
                return new Intl.NumberFormat('de-DE', {
                    style: 'currency',
                    currency: 'EUR'
                }).format(amount);
            }

        })


    })
</script>
</body>
</html>
